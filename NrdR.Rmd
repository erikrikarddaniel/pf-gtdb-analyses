---
title: "NrdR in GTDB"
author: "Daniel Lundin, Ghada Nouairia"
date: "July 9, 2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Packages}
suppressPackageStartupMessages(library(readr))
suppressPackageStartupMessages(library(feather))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(stringr))
library(ggplot2)
library(tidyverse)
library(RColorBrewer)
```

```{r Load tables}
accessions <- read_feather("data/pfitmap-gtdb-RNRs.accessions.feather")
# dbsources <- read_feather('data/pfitmap-gtdb-RNRs.dbsources.feather')
# domains <- read_feather('data/pfitmap-gtdb-RNRs.domains.feather')
hmm_profiles <- read_feather('data/pfitmap-gtdb.hmm_profiles.feather')
proteins <- read_feather('data/pfitmap-gtdb-RNRs.proteins.feather')
# sequences <- read_feather('data/pfitmap-gtdb-RNRs.sequences.feather')
taxa <- read_feather('data/pfitmap-gtdb.taxa.feather')
# tblout <- read_feather('data/pfitmap-gtdb-RNRs.tblout.feather')
# domtblout <- read_feather('data/pfitmap-gtdb-RNRs.domtblout.feather')
```

```{r all NrdRs table}
MIN_HMM_COVERAGE = 0.9

nrdrs <- hmm_profiles %>%
  filter(psuperfamily == 'NrdR-superfamily') %>%
  inner_join(proteins %>%
               filter((hmm_to - hmm_from +1)/hmmlen >= MIN_HMM_COVERAGE)
             , by = 'profile') %>%
  inner_join(accessions %>% 
            select(accno, genome_accno), 
            by = 'accno') %>%
  inner_join(taxa, by = 'genome_accno') 
```

```{r all RNR table}
rnrs = hmm_profiles %>%
  filter(psuperfamily == 'NrdGRE') %>%
  inner_join(proteins %>%
               select(accno, profile), 
             by = 'profile') %>%
  inner_join(accessions %>% 
            select(accno, genome_accno), 
            by = 'accno') %>%
  inner_join(taxa %>%
               select(genome_accno, tdomain, tphylum, tclass, torder, tfamily, tgenus, tspecies), 
             by = 'genome_accno') 
```

```{r Proportion of genomes with NrdR in domains of life}
nrdr_freq = nrdrs %>%
  distinct(tdomain, genome_accno) %>%
  group_by(tdomain) %>%
  summarise(nrdr_pres_count = n()) %>%
  inner_join(taxa %>% 
  group_by (tdomain) %>%
  summarise (genome_count = n()),
  by = 'tdomain'
  ) %>%
  mutate(proportion = nrdr_pres_count / genome_count)

nrdr_freq %>% ggplot(aes(x=tdomain, y=genome_count, fill=nrdr_pres_count)) +
  geom_bar(stat="identity")+ 
  ylab('Domain of life') +
  xlab('Number of genoems') +
  guides(fill=guide_legend(title="NrdR presence in genomes"))
```

```{r Genomes with NrdR in main taxonomic groups}
###Choose domain of life and taxonomic level
domain = 'Bacteria'
# domain = 'Archaea'
level = 'tphylum'
# level = 'tclass'

nrdr_by_level = nrdrs %>%
  filter(tdomain == domain) %>%
  group_by_at(level) %>%
  distinct(genome_accno) %>%
  summarise(nrdr_pres_count = n()) %>%
  full_join(taxa %>%
              filter(tdomain == domain) %>%
              group_by_at(level) %>%
              summarise (genome_count = n()),
            by = level) %>%
    replace_na(list(nrdr_pres_count = 0)) %>%
  mutate(proportion = nrdr_pres_count / genome_count) 

###Phyla with no nrdr or nrdr_genomes proportion < 0.01, no single genome phyla
# low_nrdr_phyla = nrdr_by_level %>% filter(proportion < 0.01 & genome_count > 1)

###Phyla with nrdr 
# high_nrdr_phyla = nrdr_by_level %>% filter(proportion > 0.7 & genome_count > 1)

###Output a table to use with anvi'o
# nrdr_by_level %>%
#   write_tsv(sprintf("./NrdR_proportions_in_%s_%s.tsv", domain, level))
 
 ###Plotting 
nrdr_by_level %>% 
  filter(genome_count > 1) %>%
  ggplot(aes_string(x=level, y="genome_count", fill="proportion")) +
  geom_bar(stat="identity") +
    scale_fill_gradient(low = "pink", high = "purple", na.value = NA) +
  ylab('Number of genomes') +
  xlab(sprintf('%s %s', domain, level)) +
   scale_y_log10() +
  guides(fill=guide_legend(title="Proportion of genomes with NrdR")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r NrdR presence with single RNR}

nrdr_srnr = rnrs %>% 
      group_by(genome_accno) %>% 
      mutate (rnrs_by_genome = n()) %>%
      filter(rnrs_by_genome == 1) %>%
  inner_join(nrdrs %>% 
               transmute(genome_accno, NrdR_accno = accno), 
             by = 'genome_accno') %>%
##124 genomes had more than one NrdR
  distinct(genome_accno, profile, accno, tdomain, tphylum, tclass, torder, tfamily, tgenus, tspecies) 
    
###Proportion of nrdr with single RNR in the genome (tibble output)
domain = 'Archaea'
level = 'tphylum'

nrdr_srnr_prop = nrdr_srnr %>%
  filter(tdomain == domain) %>%
  group_by_at(level) %>%
  mutate(count = n()) %>%
  inner_join(taxa %>%
              group_by_at(level)%>%
              summarize(genome_by_level = n()),
            by = level) %>%
  mutate(proportion = count / genome_by_level) 

nrdr_srnr_prop %>% 
  distinct_at(level) %>%
  inner_join(nrdr_srnr_prop %>% select(proportion) %>% distinct(proportion), by = level)
  
###Plot proportion of NrdR with single RNR on genome by taxonomic level

nrdr_srnr_prop %>% 
  filter(tdomain == domain) %>%
 filter(genome_by_level > 1) %>%
  distinct(tphylum, count, tdomain) %>%
  ggplot(aes_string(x="tdomain", y="count", fill=level)) +
  geom_bar(stat="identity") +
  ylab('Number of genomes with NrdR and a single RNR') +
  xlab(sprintf('NrdR with single RNR in %s', domain)) +
  guides(fill=guide_legend(title=sprintf("Distribution by %s", sublevel))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
  
```{r NrdR presence with multiple RNR}

nrdr_mrnr = rnrs %>% 
      group_by(genome_accno) %>% 
      mutate (rnrs_by_genome = n()) %>%
      filter(rnrs_by_genome > 1) %>%
  inner_join(nrdrs %>% 
               transmute(genome_accno, NrdR_accno = accno), 
             by = 'genome_accno') %>%
##294 genomes had more than one NrdR
  distinct(genome_accno, profile, accno, tdomain, tphylum, tclass, torder, tfamily, tgenus, tspecies) 
    
###Proportion of nrdr with multiple RNR in the genome (tibble output)
domain = 'Archaea'
level = 'tphylum'

nrdr_mrnr_prop = nrdr_mrnr %>%
  filter(tdomain == domain) %>%
  group_by_at(level) %>%
  mutate(count = n()) %>%
  inner_join(taxa %>%
              group_by_at(level)%>%
              summarize(genome_by_level = n()),
            by = level) %>%
  mutate(proportion = count / genome_by_level) 

nrdr_mrnr_prop %>% 
  distinct_at(level) %>%
  inner_join(nrdr_mrnr_prop %>% select(proportion) %>% distinct(proportion), by = level)
  
###Plot proportion of NrdR with multiple RNR on genome by taxonomic level

nrdr_mrnr_prop %>% 
  filter(tdomain == domain) %>%
 filter(genome_by_level > 1) %>%
  distinct(tphylum, proportion) %>%
  ggplot(aes_string(x="tphylum", y="proportion", fill=level)) +
  geom_bar(stat="identity") +
  ylab('Number of genomes with NrdR and multiple RNR') +
  xlab(sprintf('NrdR with multiple RNR in %s', domain)) +
  guides(fill=guide_legend(title=sprintf("%s", sublevel))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
  
```{r NrdR presence with multiple RNR/different classes}

###Proportion of nrdr with multiple RNR in the genome (tibble output) but from different RNR classes 
domain = 'Archaea'
level = 'tphylum'

nrdr_drnr = nrdr_mrnr %>%
  inner_join(hmm_profiles %>% select(profile, pclass), by = 'profile') %>%
  filter(tdomain == domain) %>%
  group_by(genome_accno) %>%
  mutate(pcount= n()) %>%
  ungroup %>%
  distinct(genome_accno, tphylum, pclass, pcount) %>%
  pivot_wider(names_from = pclass, values_from = pcount)
nrdr_drnr = nrdr_drnr %>% mutate(na_count = rowSums(is.na(nrdr_drnr))) %>%
  filter(na_count < 2)

###Occurence of Nrdr with each rnr class combination
nrdr_drnr %>%
  filter(is.na(NrdD)) %>%
  group_by_at(level) %>%
  mutate(NrdAJ = n()) %>%
  distinct(tphylum, NrdAJ) %>%
  full_join(nrdr_drnr %>%
               filter(is.na(NrdJ)) %>%
               group_by_at(level) %>%
               mutate(NrdAD = n()) %>%
              distinct(tphylum, NrdAD),
             by = level) %>%
  full_join(nrdr_drnr %>%
               filter(is.na(NrdA)) %>%
               group_by_at(level) %>%
               mutate(NrdJD = n()) %>%
              distinct(tphylum, NrdJD),
             by = level) %>%
  inner_join(taxa %>%
              group_by_at(level)%>%
              summarize(genome_by_level = n()),
            by = level) %>%
  mutate(NrdAJ_prop = NrdAJ / genome_by_level, NrdAD_prop = NrdAD / genome_by_level, NrdDJ_prop = NrdJD / genome_by_level) 

```
  
```{r NrdR in Archaea with class I RNR}
level = 'tphylum'

###NrdR+NrdA combination existed in one Archaeal class in each of the three phyla that had this combination (i.e. looking at phylum level, no variability by tclass was found, so we checked by torder)
sublevel = 'torder'

nrdr_nrda = nrdrs %>%
    filter(tdomain == 'Archaea') %>%
  select(genome_accno, level, sublevel, tspecies) %>%
  semi_join(rnrs %>% 
###We are supposing genomes with NrdA to have fully functional class I RNR without checking for NrdB subunit 
               filter(pclass == 'NrdA'), 
             by = 'genome_accno') %>%
  group_by_at(level) %>%
  mutate(count= n()) %>%
  inner_join(taxa %>%
              group_by_at(level)%>%
              summarize(genome_by_level = n()),
            by = level) %>%
  mutate(proportion = count/genome_by_level) 

###Proportion of genomes with NrdR and NrdA by phylum
nrdr_nrda %>%
  distinct(tphylum, count, proportion)

###Plotting NrdR + class I RNR combination by taxonomic level
nrdr_nrda %>% 
  distinct(tphylum, torder, count, genome_by_level, proportion) %>%
  # filter(genome_by_level > 1) %>%
  ggplot(aes_string(x=level, y="proportion", fill=sublevel)) +
  geom_bar(stat="identity") +
  ylab(sprintf('Proportion of %s genomes with NrdR and class I RNR', domain)) +
  xlab(sprintf('%s with NrdR and class I RNR in %s', level, domain)) +
  guides(fill=guide_legend(title=sprintf("%s", sublevel))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
  
```{r Presence of NrdR with RNR on the same strand/operon}

```
  
```{r NrdR paralogs}

```
  
  