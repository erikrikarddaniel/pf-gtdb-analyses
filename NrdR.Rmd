---
title: "NrdR in GTDB"
author: "Ghada Nouairia & Daniel Lundin"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: true
    code_folding: hide
  pdf_document:
    fig_caption: yes
    fig_height: 9
    fig_width: 8
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = 'figures/', cache = TRUE)
ggplot2::theme_set(ggplot2::theme_bw())
```

```{r libraries, message=F, cache = FALSE}
library(kfigr)
library(feather)
library(dplyr)
library(tidyr)
library(stringr)
library(DT)
library(ggplot2)
```

```{r constants}
NRDR_MIN_HMM_COVERAGE = 0.9
```

```{r load-tables}
dbsources    <- read_feather("data/pfitmap-gtdb.dbsources.feather")
hmm_profiles <- read_feather("data/pfitmap-gtdb.hmm_profiles.feather")
taxa         <- read_feather("data/pfitmap-gtdb-rep.taxa.feather")
accessions   <- read_feather("data/pfitmap-gtdb-rep-RNRs.accessions.feather")
proteins     <- read_feather("data/pfitmap-gtdb-rep-RNRs.proteins.feather")

rnr_alphas           <- read_feather('data/pfitmap-gtdb.rnr_alphas.feather')
### genomes_wo_rnr_alpha <- read_feather('data/pfitmap-gtdb-rep-RNRs.genomes_wo_rnr_alpha.feather')
rnr_class_combs      <- read_feather('data/pfitmap-gtdb-rep-RNRs.rnr_class_combs.feather') %>%
  mutate(
    rnr_combination = factor(
      rnr_combination, 
      levels = c('NrdA', 'NrdJ', 'NrdD', 'NrdA:NrdJ', 'NrdA:NrdD', 'NrdD:NrdJ', 'NrdA:NrdD:NrdJ'),
      ordered = TRUE
    )
  )
topphyla             <- read_feather('data/pfitmap-gtdb-rep.topphyla.feather')
```

```{r nrdrs}
nrdrs <- hmm_profiles %>% filter(pclass == 'NrdR') %>%
  inner_join(proteins, by = 'profile') %>%
  inner_join(accessions, by = 'accno') %>%
  inner_join(taxa, by = 'genome_accno')
```

# Data

The data in this document was based on a search for RNR proteins in  `r nrow(taxa)` 
species in the  `r dbsources %>% pull(version)`  release of the GTDB database. The
GTDB database only contains Archaea and Bacteria.

# Results

A total of 
`r nrdrs %>% distinct(genome_accno) %>% nrow()` 
GTDB species-representative genomes code for NrdR. 
Of these, the majority are bacterial, but around 10% of archaeal species also encode NrdR 
(`r figr('nrdr-domain-dist', T, type = 'Figure')`).

## NrdR with various RNR class combinations

NrdRs were found with all possible combinations of RNR classes, including a few cases of
genomes without any identified RNR alpha subunit
(`r figr('nrdr-domain-dist', T, type = 'Figure')`). 
Particularly in Archaea, NrdR together with only class II RNR is common, only class III
is relatively common in three Firmicutes_*N* phyla and only class I with NrdR is 
predominantly found in Actinobacteriota, Proteobacteria and Verrucomicrobiota.
Strikingly, two of the 20 largest bacterial phyla virtually lack NrdR: Bacteroidota and
Campylobacterota. In contrast, the two archaeal phyla that start with "Nano",
Nanoarchaeota and Nanohaloarchaeota, have strikingly large proportions of species
encoding NrdR.

```{r nrdr-domain-dist, fig.height = 2, fig.width = 6, fig.cap = '**GTDB species encoding NrdR.** Proportions were calculated to all GTDB species and not only those that encode an RNR alpha subunit.'}
nrdrs %>%
  distinct(tdomain, genome_accno) %>% # Don't count paralogs
  count(tdomain, name = 'n_species_w_nrdr') %>%
  inner_join(taxa %>% count(tdomain, name = 'n_species'), by = 'tdomain') %>%
  mutate(`Prop. species w. NrdR` = n_species_w_nrdr/n_species) %>%
  rename(`N. species w. NrdR` = n_species_w_nrdr) %>%
  pivot_longer(c(`N. species w. NrdR`, `Prop. species w. NrdR`), names_to = 'type', values_to = 'meas') %>%
  ggplot(aes(x = tdomain, y = meas)) +
  geom_col() +
  facet_wrap(~type, scales = 'free_x') +
  coord_flip() +
  xlab('Domain') +
  ylab('Number or proportion of GTDB species')
```

```{r nrdr-in-rnr-combs, fig.height = 7, fig.cap = '**NrdR in presence of different RNR class combinations.** Proportions usually do not sum to one because species without any detected RNR alpha subunits were included.'}
nrdrs %>% left_join(rnr_class_combs %>% select(genome_accno, rnr_combination), by = 'genome_accno') %>%
  # Join with topphyla to get names for the 20 largest phyla in Archaea and Bacteria
  inner_join(topphyla %>% select(tdomain, tphylum, top20phyla), by = c('tdomain', 'tphylum')) %>%
  count(tdomain, top20phyla, rnr_combination, name = 'n_nrdr_species') %>%
  # Join a second time with topphyla to get total number of species per top20phyla group
  inner_join(
    topphyla %>% group_by(tdomain, top20phyla) %>% summarise(n_species = sum(n_species), .groups = 'drop'),
    by = c('tdomain', 'top20phyla')
  ) %>%
  mutate(
    `Prop. NrdR species` = n_nrdr_species/n_species,
    rnr_combination = forcats::fct_explicit_na(rnr_combination, na_level = 'No RNR alpha')
  ) %>%
  rename(`N. NrdR species` = n_nrdr_species) %>%
  select(-n_species) %>%
  pivot_longer(c(`N. NrdR species`, `Prop. NrdR species`), names_to = 'type', values_to = 'meas') %>%
  ggplot(aes(x = top20phyla, y = meas, fill = rnr_combination)) +
  geom_col() +
  scale_fill_brewer('RNR combination', palette = 'Paired') +
  facet_wrap(tdomain ~ type, scales = 'free') +
  xlab('Phylum') + ylab('N. or prop. NrdR species') +
  coord_flip() +
  theme(
    legend.position = 'bottom'
  )
```

## NrdRs in single class species

* Count number of RNR alphas
* Look at subclasses