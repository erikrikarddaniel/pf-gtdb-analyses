---
title: "NrdR in GTDB"
author: "Ghada Nouairia & Daniel Lundin"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: true
    code_folding: hide
  pdf_document:
    fig_caption: yes
    fig_height: 9
    fig_width: 8
    number_sections: yes
    toc: yes
bibliography: [ bibliography.bib ]
biblio-style: apalike
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = 'figures/', cache = TRUE)
ggplot2::theme_set(ggplot2::theme_bw())
```

```{r libraries, message=F, cache = FALSE}
library(kfigr)
library(feather)
library(dplyr)
library(tidyr)
library(stringr)
library(DT)
library(ggplot2)
```

```{r constants}
NRDR_MIN_HMM_COVERAGE = 0.9
```

```{r load-tables}
dbsources    <- read_feather("data/pfitmap-gtdb.dbsources.feather")
hmm_profiles <- read_feather("data/pfitmap-gtdb.hmm_profiles.feather")
taxa         <- read_feather("data/pfitmap-gtdb-rep.taxa.feather")
accessions   <- read_feather("data/pfitmap-gtdb-rep-RNRs.accessions.feather")
proteins     <- read_feather("data/pfitmap-gtdb-rep-RNRs.proteins.feather")
domains      <- read_feather("data/pfitmap-gtdb-rep-RNRs.domains.feather")

rnr_alphas           <- read_feather('data/pfitmap-gtdb.rnr_alphas.feather')
### genomes_wo_rnr_alpha <- read_feather('data/pfitmap-gtdb-rep-RNRs.genomes_wo_rnr_alpha.feather')
rnr_class_combs      <- read_feather('data/pfitmap-gtdb-rep-RNRs.rnr_class_combs.feather') %>%
  mutate(
    rnr_combination = factor(
      rnr_combination, 
      levels = c('NrdA', 'NrdJ', 'NrdD', 'NrdA:NrdJ', 'NrdA:NrdD', 'NrdD:NrdJ', 'NrdA:NrdD:NrdJ'),
      ordered = TRUE
    )
  )
topphyla             <- read_feather('data/pfitmap-gtdb-rep.topphyla.feather')

atp_cones <- hmm_profiles %>% filter(profile == 'ATP-cone') %>%
  inner_join(domains %>% distinct(profile, accno), by = 'profile')
```

```{r nrdrs}
nrdrs <- hmm_profiles %>% filter(pclass == 'NrdR') %>%
  inner_join(proteins, by = 'profile') %>%
  inner_join(accessions, by = 'accno') %>%
  inner_join(taxa, by = 'genome_accno')
```

# Data

The data in this document was based on a search for RNR proteins in  `r nrow(taxa)` *species* --
i.e. the representative genome of each species -- in the  `r dbsources %>% pull(version)`  release
of the GTDB database. The representative genome is the one that is considered "best" in terms of
completeness, contaminiation etc. 

The GTDB database only contains Archaea and Bacteria.

# Results

A total of 
`r nrdrs %>% distinct(genome_accno) %>% nrow()` 
GTDB species-representative genomes encode NrdR. 
Of these, the majority are bacterial, but around 10% of archaeal species also encode NrdR 
(`r figr('nrdr-domain-dist', T, type = 'Figure')`).

There are `r nrdrs %>% group_by(genome_accno) %>% filter(n() > 1) %>% nrow()` species representative
genomes encoding more than one copy of NrdR.

```{r nrdr-domain-dist, fig.height = 2, fig.width = 6, fig.cap = '**GTDB species encoding NrdR.** Proportions were calculated to all GTDB species and not only those that encode an RNR alpha subunit.'}
nrdrs %>%
  distinct(tdomain, genome_accno) %>% # Don't count paralogs
  count(tdomain, name = 'n_species_w_nrdr') %>%
  inner_join(taxa %>% count(tdomain, name = 'n_species'), by = 'tdomain') %>%
  mutate(`Prop. species w. NrdR` = n_species_w_nrdr/n_species) %>%
  rename(`N. species w. NrdR` = n_species_w_nrdr) %>%
  pivot_longer(c(`N. species w. NrdR`, `Prop. species w. NrdR`), names_to = 'type', values_to = 'meas') %>%
  ggplot(aes(x = tdomain, y = meas)) +
  geom_col() +
  facet_wrap(~type, scales = 'free_x') +
  coord_flip() +
  xlab('Domain') +
  ylab('Number or proportion of GTDB species')
```

## NrdR with various RNR class combinations

NrdRs were found with all possible combinations of RNR classes, including a few cases of
genomes without any identified RNR alpha subunit
(`r figr('nrdr-in-rnr_combs', T, type = 'Figure')`). 
Particularly in Archaea, NrdR together with only class II RNR is common, only class III
is relatively common in three Firmicutes_*N* phyla and only class I with NrdR is 
predominantly found in Actinobacteriota, Proteobacteria and Verrucomicrobiota.
Strikingly, two of the 20 largest bacterial phyla virtually lack NrdR: Bacteroidota and
Campylobacterota. In contrast, the two archaeal phyla that start with "Nano",
Nanoarchaeota and Nanohaloarchaeota, have strikingly large proportions of species
encoding NrdR.

Paper about a cultured Nanohaloarchaeota species: [ @la_cono_symbiosis_2020 ]

```{r nrdr-in-rnr-combs, fig.height = 7, fig.cap = '**NrdR in presence of different RNR class combinations.** Proportions usually do not sum to one because species without any detected RNR alpha subunits were included.'}
nrdrs %>% left_join(rnr_class_combs %>% select(genome_accno, rnr_combination), by = 'genome_accno') %>%
  # Join with topphyla to get names for the 20 largest phyla in Archaea and Bacteria
  inner_join(topphyla %>% select(tdomain, tphylum, top20phyla), by = c('tdomain', 'tphylum')) %>%
  count(tdomain, top20phyla, rnr_combination, name = 'n_nrdr_species') %>%
  # Join a second time with topphyla to get total number of species per top20phyla group
  inner_join(
    topphyla %>% group_by(tdomain, top20phyla) %>% summarise(n_species = sum(n_species), .groups = 'drop'),
    by = c('tdomain', 'top20phyla')
  ) %>%
  mutate(
    `Prop. NrdR species` = n_nrdr_species/n_species,
    rnr_combination = forcats::fct_explicit_na(rnr_combination, na_level = 'No RNR alpha')
  ) %>%
  rename(`N. NrdR species` = n_nrdr_species) %>%
  select(-n_species) %>%
  pivot_longer(c(`N. NrdR species`, `Prop. NrdR species`), names_to = 'type', values_to = 'meas') %>%
  ggplot(aes(x = top20phyla, y = meas, fill = rnr_combination)) +
  geom_col() +
  scale_fill_brewer('RNR combination', palette = 'Paired') +
  facet_wrap(tdomain ~ type, scales = 'free') +
  xlab('Phylum') + ylab('N. or prop. NrdR species') +
  coord_flip() +
  theme(
    legend.position = 'bottom'
  )
```

## NrdRs in single class species

It is not uncommon to find NrdR in species encoding a single RNR alpha subunit of a single class
and it appears similarly widespread for all three classes
(`r figr('num-single-class-rnr-alphas-plot', T, type = 'Figure')` and
`r figr('num-single-class-rnr-alphas-table', T, type = 'Table')`).

```{r num-single-class-rnr-alphas-plot, fig.height = 8, fig.width = 12, fig.cap = '**Number of species in which NrdR is associated with one or more RNRs of the same class.** (*Note:* I know the scale for number of bacterial genomes is strange, but not why.)'}
single_class_nrdrs <- nrdrs %>% select(genome_accno, tdomain:tspecies) %>% distinct() %>%
  inner_join(
    rnr_class_combs %>% filter(rnr_combination %in% c('NrdA', 'NrdJ', 'NrdD')) %>%
      select(genome_accno, rnr_combination) %>%
      inner_join(
        rnr_alphas %>% inner_join(proteins, by = 'profile') %>%
          inner_join(accessions, by = 'accno') %>%
          count(genome_accno, name = 'n_rnr_alphas'),
        by = 'genome_accno'
      ),
    by = 'genome_accno'
  ) 
c <- single_class_nrdrs %>%
  count(tdomain, tphylum, rnr_combination, n_rnr_alphas, name = 'n_nrdr_species') %>%
  mutate(
    n_rnr_alphas = ifelse(n_rnr_alphas > 3, '>3 RNR alphas', sprintf('%d RNR alphas', n_rnr_alphas)) %>%
      factor(
        levels = c('1 RNR alphas', '2 RNR alphas', '3 RNR alphas', '>3 RNR alphas'),
        ordered = TRUE
      ) 
  ) 
c %>%
  inner_join(topphyla %>% select(tdomain, tphylum, top20phyla), by = c('tdomain', 'tphylum')) %>%
  group_by(tdomain, top20phyla, rnr_combination, n_rnr_alphas) %>%
  summarise(n_nrdr_species = sum(n_nrdr_species), .groups = 'drop') %>%
  mutate(n_nrdr_species = factor(n_nrdr_species)) %>%
  ggplot(aes(x = top20phyla, y = n_nrdr_species, fill = n_rnr_alphas)) +
  geom_col() +
  scale_fill_viridis_d('N. RNR alpha paralogs') +
  facet_wrap(tdomain ~ rnr_combination, scales = 'free') +
  coord_flip() +
  xlab('Phylum') +
  ylab('N. NrdR species') +
  theme(legend.position = 'bottom')
```

```{r num-single-class-rnr-alphas-table, fig.cap = '**Number of species in which NrdR is associated with one or more RNRs of the same class.**'}
c %>% pivot_wider(names_from = n_rnr_alphas, values_from = n_nrdr_species, values_fn = list) %>%
  datatable(
    colnames = c('Domain' = 'tdomain', 'Phylum' = 'tphylum', 'RNR combination' = 'rnr_combination')
  )
```

### NrdRs with multiple RNRs of the same class

Among species with more than one RNR of the same class combined with an NrdR, it's most common to find
two different subclasses but a fair number of species have a single subclass
(`r figr('single-class-subclasses', T, type = 'Figure')`).

```{r single-class-subclass, fig.height = 6, fig.width = 8, fig.cap = "**Number of different subclasses in species with an NrdR combined with more than one RNR of the same class.**"}
single_class_nrdrs %>% filter(n_rnr_alphas > 1, tdomain == 'Bacteria') %>%
  inner_join(
    accessions %>% select(accno, genome_accno) %>%
      inner_join(proteins %>% select(accno, profile), by = 'accno'),
    by = 'genome_accno'
  ) %>%
  inner_join(rnr_alphas %>% select(profile, pclass:psubclass), by = 'profile') %>%
  group_by(tdomain, tphylum, tclass, pclass, tspecies, psubclass) %>%
  summarise(n_subclass = n(), .groups = 'drop_last') %>%
  summarise(n_subclasses = n(), .groups = 'drop') %>%
  mutate(
    n_subclasses = sprintf("%d subclasses", n_subclasses)
  ) %>%
  inner_join(topphyla %>% select(tdomain, tphylum, top20phyla), by = c('tdomain', 'tphylum')) %>%
  group_by(tdomain, top20phyla, pclass, n_subclasses) %>%
  summarise(n_subclassnum = n(), .groups = 'drop') %>%
  ggplot(aes(x = top20phyla, y = n_subclassnum, fill = n_subclasses)) +
  geom_col() +
  scale_fill_viridis_d('N. different subclasses') +
  facet_wrap(tdomain ~ pclass) +
  coord_flip() +
  theme(legend.position = 'bottom') +
  ylab('N. species') +
  xlab('Phylum')
```

## Are NrdRs complementing activity regulation?

There is no obvious relationship between NrdRs with single RNRs without ATP-cones,
(`r figr('single-rnr-atp-cones', T, type = 'Figure')`).

```{r single-rnr-atp-cones, fig.height = 4, fig.width = 10, fig.cap = "**Genomes with a single RNR with or without ATP-cone, with or without NrdR in the genome.**"}
atpc_rnrs <- rnr_alphas %>%
  inner_join(proteins %>% select(profile, accno), by = 'profile') %>%
  left_join(atp_cones %>% transmute(accno, atp_cones = 1), by = 'accno') %>%
  replace_na(list(atp_cones = 0)) %>%
  group_by(accno, pclass, psubclass) %>% summarise(atp_cones = sum(atp_cones), .groups = 'drop') %>%
  inner_join(accessions %>% select(accno, genome_accno), by = 'accno') %>%
  inner_join(taxa, by = 'genome_accno')
atpc_rnrs %>% 
  group_by(genome_accno) %>% filter(n() == 1) %>% ungroup() %>%
  left_join(nrdrs %>% transmute(genome_accno, nrdrs = 1), by = 'genome_accno') %>%
  replace_na(list(nrdrs = 0)) %>%
  mutate(
    atpc_nrdr = case_when(
      atp_cones > 0 & nrdrs > 0 ~ 'NrdR ATP-cone',
      atp_cones > 0             ~ 'Only ATP-cone',
                      nrdrs > 0 ~ 'NrdR no ATP-cone',
      TRUE                      ~ 'Neither'
    )
  ) %>%
  inner_join(topphyla %>% select(tphylum:top50phyla), by = 'tphylum') %>%
  count(tdomain, top20phyla, atpc_nrdr) %>% 
  ggplot(aes(x = top20phyla, y = n, fill = atpc_nrdr)) +
  geom_col() +
  #scale_fill_brewer() + #palette = 'Paired') +
  scale_fill_viridis_d('Combination') +
  facet_wrap(~tdomain, scales = 'free') +
  xlab('N. species') + ylab('Phylum') +
  coord_flip() +
  theme(legend.position = 'bottom')
```

# References {-}
