---
title: "NrdR in GTDB"
author: "Daniel Lundin, Ghada Nouairia"
date: "July 9, 2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Packages}
suppressPackageStartupMessages(library(readr))
suppressPackageStartupMessages(library(feather))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(stringr))
library(ggplot2)
library(tidyverse)
```

```{r Load tables}
accessions <- read_feather("pfitmap-RNRs-gtdb.accessions.feather")
# dbsources <- read_feather('pfitmap-gtdb.dbsources.feather')
# domains <- read_feather('pfitmap-gtdb.domains.feather')
hmm_profiles <- read_feather('pfitmap-gtdb.hmm_profiles.feather')
proteins <- read_feather('pfitmap-RNRs-gtdb.proteins.feather')
# sequences <- read_feather('pfitmap-RNRs-gtdb.sequences.feather')
taxa <- read_feather('pfitmap-gtdb.taxa.feather')
# tblout <- read_feather('pfitmap-RNRs-gtdb.tblout.feather')
# domtblout <- read_feather('pfitmap-gtdb.domtblout.feather')
```

```{r Filter NrdR superfamily only}
nrdrs <- hmm_profiles %>%
  filter(psuperfamily == 'NrdR-superfamily') %>%
  inner_join(proteins, by = 'profile') %>%
  inner_join(accessions %>% 
            select(accno, genome_accno), 
            by = 'accno') %>%
  inner_join(taxa, by = 'genome_accno') 
```

```{r Proportion of genomes with NrdR in domains of life}
nrdr_freq = nrdrs %>%
  distinct(tdomain, genome_accno) %>%
  group_by(tdomain) %>%
  summarise(nrdr_pres_count = n()) %>%
  inner_join(taxa %>% 
  group_by (tdomain) %>%
  summarise (genome_count = n()),
  by = 'tdomain'
  ) %>%
  mutate(proportion = nrdr_pres_count / genome_count)
```

```{r Genomes with NrdR in main taxonomic groups}
###Choose domain of life and taxonomic level
domain = 'Bacteria'
level = 'tphylum'

nrdr_by_level = nrdrs %>%
  filter(tdomain == domain) %>%
  group_by_at(level) %>%
  distinct(genome_accno) %>%
  summarise(nrdr_pres_count = n()) %>%
  full_join(taxa %>%
              filter(tdomain == domain) %>%
              group_by_at(level) %>%
              summarise (genome_count = n()),
            by = level) %>%
    replace_na(list(nrdr_pres_count = 0)) %>%
  mutate(proportion = nrdr_pres_count / genome_count) 

###Output a table to use with anvi'o
# nrdr_by_level %>%
#   write_tsv(sprintf("./NrdR_proportions_in_%s_%s.tsv", domain, level))
 
 ###Plotting 
 nrdr_by_level %>% 
    ggplot(aes_string(x=level, y='proportion')) +
  geom_bar(stat="identity")+
  ylab('Proportion of NrdR') +
  xlab(sprintf('%s %s', domain, level)) +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
 theme_minimal()
```

```{r NrdR presence with single RNR}

```
  
```{r NrdR presence with multiple RNR/same class}

```
  
```{r NrdR presence with multiple RNR/different classes}

```
  
```{r Presence of NrdR with RNR on the same strand/operon}

```
  
```{r NrdR presence with RNR classes}

```
  
  