---
title: "Overview of RNR proteins in GTDB *species*"
author: "daniel.lundin@dbb.su.se & ghada.nouaria@dbb.su.se"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: true
    code_folding: hide
  pdf_document:
    fig_caption: yes
    fig_height: 9
    fig_width: 8
    number_sections: yes
    toc: yes
---

```{r setup, echo=F, cache = FALSE}
knitr::opts_chunk$set(echo=F, fig.path='figures/', cache = TRUE)
ggplot2::theme_set(ggplot2::theme_bw())
```

```{r libraries, message=F, cache = FALSE}
suppressPackageStartupMessages(library(readr))
suppressPackageStartupMessages(library(feather))
#suppressPackageStartupMessages(library(data.table))
#suppressPackageStartupMessages(library(dtplyr))
suppressPackageStartupMessages(library(dplyr, warn.conflicts = FALSE))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(kfigr))
suppressPackageStartupMessages(library(knitr))
```

```{r constants}
```

```{r read-data}
dbsources    <- read_feather("data/pfitmap-gtdb.dbsources.feather")
hmm_profiles <- read_feather("data/pfitmap-gtdb.hmm_profiles.feather")
taxa         <- read_feather("data/pfitmap-gtdb-rep.taxa.feather")
accessions   <- read_feather("data/pfitmap-gtdb-rep-RNRs.accessions.feather")
### domains      <- read_feather("data/pfitmap-gtdb-rep-RNRs.domains.feather")
proteins     <- read_feather("data/pfitmap-gtdb-rep-RNRs.proteins.feather")
### sequences    <- read_feather("data/pfitmap-gtdb-rep-RNRs.sequences.feather")

# Convenience tables and numbers
rnr_alphas <- hmm_profiles %>% filter(pclass %in% c('NrdA', 'NrdD', 'NrdJ'))

n_rnr_species <- rnr_alphas %>%
  inner_join(proteins %>% select(profile, accno), by = 'profile') %>% 
  inner_join(accessions %>% distinct(accno, genome_accno), by = 'accno') %>% 
  distinct(genome_accno) %>% count() %>% pull(n)
```

# Data

The data in this document was based on a search for RNR proteins in  `r nrow(taxa)` 
species in the  `r dbsources %>% pull(version)`  release of the GTDB database. The
GTDB database only contains Archaea and Bacteria.

# RNR presence in genomes

Of a total of `r nrow(taxa)` species,
`r n_rnr_species` contained at least one catalytic subunit RNR protein, i.e.
`r round(n_rnr_species/nrow(taxa)*100)`%. 
Genome completeness does not seem to be a major factor in explaining the absence of RNR alpha subunits
(`r figr('missing-rnr-completeness', T, type = 'Figure')`).
Nor does different requirements for how much of the HMM model is covered by alignments appear to influence
the number of genomes with at least one RNR alpha subunit
(`r figr("num-genomes-hmm-coverage", T, type = "Figure")`).

```{r missing-rnr-completeness, fig.height = 4, fig.cap = '**Number of species representative GTDB genomes missing any RNR alpha subunit as a function of genome completeness.**'}
taxa %>% transmute(
  genome_accno, 
  tdomain, 
  completeness = as.numeric(checkm_completeness),
  compl_interval = ceiling(completeness / 5) * 5
) %>%
  anti_join(
    rnr_alphas %>% inner_join(proteins, by = 'profile') %>% inner_join(accessions, by = 'accno'),
    by = 'genome_accno'
  ) %>%
  count(tdomain, compl_interval) %>%
  ggplot(aes(x = compl_interval, y = n, fill = tdomain)) +
  geom_col() +
  scale_fill_discrete('Domain') +
  ylab('N. genomes without RNR') + xlab('Completeness percent intervall')
```

```{r num-genomes-hmm-coverage, fig.height = 4, fig.cap = "**Number of genomes with at least one RNR catalytic subunit as a function of different degrees of HMM model coverage.** Although the number of genomes appear to decrease radically between 0.85 and 0.9, note that the y-axis scale is very short."}
tibble(min_hmm_coverage = c(0.25, 0.5, 0.6, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1.00)) %>%
  mutate(
    n_genomes = purrr::map(
      min_hmm_coverage,
      function(cov) {
        rnr_alphas %>% 
          inner_join(proteins, by = 'profile') %>%
          filter(plen / hmmlen >= cov) %>%
          inner_join(accessions, by = 'accno') %>%
          count()
      }
    )
  ) %>%
  unnest(n_genomes) %>%
  ggplot(aes(x = min_hmm_coverage, y = n)) +
  geom_line() +
  xlab('Minimum HMM model coverage') +
  ylab('Number of genomes with at least on RNR alpha subunit')
```

