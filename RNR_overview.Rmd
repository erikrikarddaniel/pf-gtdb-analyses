---
title: "Overview of RNR proteins in GTDB *species*"
author: "daniel.lundin@dbb.su.se & ghada.nouaria@dbb.su.se"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: true
    code_folding: hide
  pdf_document:
    fig_caption: yes
    fig_height: 9
    fig_width: 8
    number_sections: yes
    toc: yes
---

```{r setup, echo=F, cache = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path='figures/', cache = TRUE)
ggplot2::theme_set(ggplot2::theme_bw())
```

```{r libraries, message=F, cache = FALSE}
suppressPackageStartupMessages(library(readr))
suppressPackageStartupMessages(library(feather))
#suppressPackageStartupMessages(library(data.table))
#suppressPackageStartupMessages(library(dtplyr))
suppressPackageStartupMessages(library(dplyr, warn.conflicts = FALSE))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(kfigr))
suppressPackageStartupMessages(library(knitr))
```

```{r constants}
```

```{r read-data}
dbsources    <- read_feather("data/pfitmap-gtdb.dbsources.feather")
hmm_profiles <- read_feather("data/pfitmap-gtdb.hmm_profiles.feather")
taxa         <- read_feather("data/pfitmap-gtdb-rep.taxa.feather") %>%
  mutate(
    checkm_completeness = as.numeric(checkm_completeness),
    checkm_contamination = as.numeric(checkm_contamination),
    checkm_strain_heterogeneity = as.numeric(checkm_strain_heterogeneity),
    genome_size = as.numeric(genome_size),
    est_genome_size = genome_size/checkm_completeness*100,
    genome_size_class = ceiling(est_genome_size/1e6)
  )
accessions   <- read_feather("data/pfitmap-gtdb-rep-RNRs.accessions.feather")
### domains      <- read_feather("data/pfitmap-gtdb-rep-RNRs.domains.feather")
proteins     <- read_feather("data/pfitmap-gtdb-rep-RNRs.proteins.feather")
### sequences    <- read_feather("data/pfitmap-gtdb-rep-RNRs.sequences.feather")
```
```{r tables-and-numbers}
# Convenience tables and numbers
rnr_alphas <- hmm_profiles %>% filter(pclass %in% c('NrdA', 'NrdD', 'NrdJ'))

major_phyla <- taxa %>% 
  count(tdomain, tphylum, name = "n_genomes") %>% 
  group_by(tdomain) %>% top_n(20, n_genomes) %>% ungroup() %>%
  mutate(major_phylum = tphylum)
major_phyla <- major_phyla %>% 
  union(
    taxa %>% anti_join(major_phyla, by = c('tdomain', 'tphylum')) %>%
      count(tdomain, tphylum, major_phylum = NA, name = "n_genomes")
  ) %>%
  mutate(major_phylum = forcats::fct_explicit_na(major_phylum, na_level = 'Other phyla'))

genomes_wo_rnr_alpha <- taxa %>% 
  select(genome_accno, tdomain:tspecies) %>%
  anti_join(
    rnr_alphas %>% inner_join(proteins, by = 'profile') %>%
      inner_join(accessions, by = 'accno'),
    by = "genome_accno"
  ) 

n_rnr_species <- rnr_alphas %>%
  inner_join(proteins %>% select(profile, accno), by = 'profile') %>% 
  inner_join(accessions %>% distinct(accno, genome_accno), by = 'accno') %>% 
  distinct(genome_accno) %>% count() %>% pull(n)

rnr_class_combs <- rnr_alphas %>%
  inner_join(proteins, by = 'profile') %>%
  inner_join(accessions, by = 'accno') %>%
  distinct(genome_accno, pclass) %>%
  pivot_wider(names_from = pclass, values_from = pclass) %>%
  unite(rnr_combination, NrdA, NrdD, NrdJ, sep = ':', na.rm = TRUE) %>%
  mutate(
    rnr_combination = factor(
      rnr_combination,
      levels = c('NrdA', 'NrdJ', 'NrdD', 'NrdA:NrdJ', 'NrdA:NrdD', 'NrdD:NrdJ', 'NrdA:NrdD:NrdJ'),
      ordered = TRUE
    )
  ) %>%
  inner_join(taxa, by = 'genome_accno')
```

# Data

The data in this document was based on a search for RNR proteins in  `r nrow(taxa)` 
species in the  `r dbsources %>% pull(version)`  release of the GTDB database. The
GTDB database only contains Archaea and Bacteria.

# RNR presence in species

## Species lacking RNR alpha subunits

Of a total of `r nrow(taxa)` species,
`r n_rnr_species` contained at least one catalytic subunit RNR protein, i.e.
`r round(n_rnr_species/nrow(taxa)*100)`%. 
Genome completeness does not seem to be a major factor in explaining the absence of RNR alpha subunits
(`r figr('missing-rnr-completeness', T, type = 'Figure')`).
Nor does different requirements for how much of the HMM model is covered by alignments appear to influence
the number of genomes with at least one RNR alpha subunit
(`r figr("num-genomes-hmm-coverage", T, type = "Figure")`).

In many phyla around 10-30% of species lack identified RNR alpha subunits
(`r figr("no-rnr-alpha-phylum-dist", T, type = "Figure")`).

```{r missing-rnr-completeness, fig.height = 3, fig.cap = '**Number of species representative GTDB genomes missing any RNR alpha subunit as a function of genome completeness.**'}
taxa %>% transmute(
  genome_accno, 
  tdomain, 
  completeness = as.numeric(checkm_completeness),
  compl_interval = ceiling(completeness / 5) * 5
) %>%
  anti_join(
    rnr_alphas %>% inner_join(proteins, by = 'profile') %>% inner_join(accessions, by = 'accno'),
    by = 'genome_accno'
  ) %>%
  count(tdomain, compl_interval) %>%
  ggplot(aes(x = compl_interval, y = n, fill = tdomain)) +
  geom_col() +
  scale_fill_discrete('Domain') +
  ylab('N. genomes without RNR') + xlab('Completeness percent intervall')
```

```{r num-genomes-hmm-coverage, fig.height = 3, fig.cap = "**Number of genomes with at least one RNR catalytic subunit as a function of different degrees of HMM model coverage.** Although the number of genomes appear to decrease radically between 0.85 and 0.9, note that the y-axis scale is very short and that it's actually only about 250 species that lose their RNRs between these levels."}
tibble(min_hmm_coverage = c(0.25, 0.5, 0.6, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1.00)) %>%
  mutate(
    n_genomes = purrr::map(
      min_hmm_coverage,
      function(cov) {
        rnr_alphas %>% 
          inner_join(proteins, by = 'profile') %>%
          filter(plen / hmmlen >= cov) %>%
          inner_join(accessions, by = 'accno') %>%
          count()
      }
    )
  ) %>%
  unnest(n_genomes) %>%
  ggplot(aes(x = min_hmm_coverage, y = n)) +
  geom_line() +
  xlab('Minimum HMM model coverage') +
  ylab('Number of genomes with at least on RNR alpha subunit')
```

```{r no-rnr-alpha-phylum-dist, fig.height = 7, fig.cap = "**Species missing RNR alpha subunits per phylum.** The top two panels show the number of species that do not encode any identified RNR alpha subunit, while the bottom two show the proportion of species per phylum that do not encode RNR alphas."}
genomes_wo_rnr_alpha %>%
  count(tdomain, tphylum) %>%
  inner_join(major_phyla, by = c('tdomain', 'tphylum')) %>%
  group_by(tdomain, major_phylum) %>% summarise(n = sum(n), n_genomes = sum(n_genomes), .groups = 'drop') %>%
  transmute(tdomain, major_phylum, `Proportion of species` = n/n_genomes, `Number of species` = n) %>%
  pivot_longer(c(`Proportion of species`, `Number of species`), names_to = 'type', values_to = 'meas') %>%
  ggplot(aes(x = major_phylum, y = meas)) +
  geom_col() +
  facet_wrap(type~tdomain, scales = 'free') +
  coord_flip() +
  xlab("Phylum") +
  ylab("Number or proportion of species missing RNR alpha subunits")
```

## Distribution of RNR classes in GTDB species

All possible combinations of RNRs are present in GTDB species
(`r figr('rnr-classcombs', T, type = 'Table')`)
although class I is rare in Archaea. However, a decent number of Archaea rely solely on class I, particularly in the
Thermoplasmatota, while the Halobacterota encode most of the rest of class I RNRs, though usually in combination with class II
(`figr('rnr-classcomb-phylum-dist', T, type = 'Figure')`). 
Otherwise, class II and III dominate in Archaea with most phyla mostly encoding class II, with the exceptions of 
Euryarchaeota and Altiarchaeota which encode proportionally more class III RNRs.

The "Candidate phyla radiation (CPR)" is known as Patescibacteria in GTDB, more than half of which rely solely on class II.
This reliance on class II is shared with Cyanobacteria,
Chloroflexota and Acidobacteriota. Almost half the species in the, admittedly small, Firmicutes_I phylum, encode all three 
classes of RNR. The much larger Firmicutes_A rely on class III, whereas the Firmicutes encode many different combinations just
like Actinobacteriota, Bacteroidota, Proteobacteria and Verrucomicrobia
(`r figr('rnr-classcomb-phylum-dist', T, type = 'Figure')`). 

```{r rnr-classcombs, fig.cap = "**RNR class combinations in the two GTDB domains.**", cache = FALSE}
rnr_class_combs %>% count(tdomain, rnr_combination) %>%
  pivot_wider(names_from = tdomain, values_from = n) %>%
  rename(`RNR combination` = rnr_combination) %>%
  datatable()
```


```{r rnr-classcomb-phylum-dist, fig.height = 8, fig.cap = "**Number of species with different combinations of RNR classes per phylum.** Class combinations were calculated based on presence of RNR alpha subunits. Proportions to not sum to 1, as genomes without any RNRs were included in the calculations."}
rnr_class_combs %>%
  count(rnr_combination, tdomain, tphylum, name = 'n_combs') %>%
  inner_join(major_phyla, by = c('tdomain', 'tphylum')) %>%
  group_by(rnr_combination, tdomain, major_phylum) %>%
  summarise(n_combs = sum(n_combs), n_genomes = sum(n_genomes), .groups = 'drop') %>%
  transmute(rnr_combination, tdomain, major_phylum, `Number of species` = n_combs, `Proportion of species` = n_combs/n_genomes) %>%
  pivot_longer(c(`Proportion of species`, `Number of species`), names_to = 'type', values_to = 'meas') %>%
  ggplot(aes(x = major_phylum, y = meas, fill = rnr_combination)) +
  geom_col() +
  scale_fill_brewer('RNR class combination', palette = 'Paired') +
  facet_wrap(type~tdomain, scales = 'free') +
  coord_flip() +
  xlab("Phylum") +
  ylab("Number or proportion of species with RNR class presence") +
  theme(
    legend.position = 'bottom'
  )
```

## Relationship between genome size and RNR repertoire

Presence of combinations of RNR classes increase with increasing genome size,
particularly in Bacteria. Most combinations peak in genomes of 4-10 Mbp, except
class I + II, which continue to increase beyond 10 Mbp (although this happens in
a small number of genomes) and class II + III which peaks earlier than other
combinations
(`r figr('rnr-combs-genome-size', T, type = 'Figure')`).
The majority of very large genomes containing class I + II are Actinobacteria
(`r figr('large-genomes-rnr-combs', T, type = 'Table')`), especially *Streptomyces* spp.
(`r figr('large-actinos-rnr-combs', T, type = 'Table')`).

```{r rnr-combs-genome_size, fig.height = 6, fig.cap = "**Presence of combinations of RNR classes in genome size classes.** Proportions do not reach 1 because genomes without identified RNRs were included in the total."}
rnr_class_combs %>%
  filter(genome_size_class <= 20) %>%
  count(tdomain, rnr_combination, genome_size_class, name = "n_species_per_comb") %>%
  inner_join(
    taxa %>% count(tdomain, genome_size_class, name = "n_species"),
    by = c('tdomain', 'genome_size_class')
  ) %>%
  transmute(
    rnr_combination, tdomain, genome_size_class, 
    `Number of species` = n_species_per_comb, `Proportion of species` = n_species_per_comb/n_species
  ) %>%
  pivot_longer(c(`Proportion of species`, `Number of species`), names_to = 'type', values_to = 'meas') %>%
  ggplot(aes(x = genome_size_class, y = meas, fill = rnr_combination)) +
  geom_col() +
  scale_fill_brewer('RNR class combination', palette = 'Paired') +
  facet_wrap(type~tdomain, scales = 'free_y') +
  xlab("Upper limit genome size (Mbp)") +
  ylab("Number or proportion of species with RNR class presence") +
  theme(
    legend.position = 'bottom'
  )
```

```{r large-genomes-rnr-combs, fig.cap = "**RNR class combinations in genomes larger than 10 Mbp.**", cache = FALSE}
rnr_class_combs %>% filter(est_genome_size > 1e7) %>%
  count(tdomain, tphylum, tclass, genome_size_class, rnr_combination, name = "n_species") %>%
  pivot_wider(names_from = rnr_combination, values_from = n_species, values_fill = 0) %>%
  datatable(
    colnames = c(
      'Domain' = 'tdomain', 'Phylum' = 'tphylum', 'Class' = 'tclass',
      'Genome Mbp' = 'genome_size_class'
    )
  )
```

```{r large-actinos-rnr-combs, fig.cap = "**Large (>= 10 Mbp) actinobacterial genomes and their RNR class combinations.**", cache = FALSE}
rnr_class_combs %>% filter(tclass == 'Actinobacteria', genome_size_class >= 10) %>%
  count(torder, tfamily, tgenus, rnr_combination, name = 'n_genomes') %>%
  pivot_wider(names_from = rnr_combination, values_from = n_genomes, values_fill = 0) %>%
  datatable()
```

